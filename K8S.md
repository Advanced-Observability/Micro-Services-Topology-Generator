# Kubernetes

You can generate the configuration files for deploying the architecture on a [Kubernetes](https://kubernetes.io/) cluster.

## K8S distribution

We tested our solution on the following Kubernetes distributions:
- [kind](https://kind.sigs.k8s.io/)

> [!WARNING]
> [Minikube](https://minikube.sigs.k8s.io/docs/) does **NOT** support IPv6 as of February 12, 2024.
See [official Q&A](https://minikube.sigs.k8s.io/docs/faq/#does-minikube-support-ipv6) and [GitHub issue](https://github.com/kubernetes/minikube/issues/8535).

## Cluster configurations

### General

In order for MSTG to work on Kubernetes, you need to allow the following [unsafe sysctls](https://kubernetes.io/docs/tasks/administer-cluster/sysctl-cluster/#enabling-unsafe-sysctls) in your cluster:
- `net.ipv4.*`
- `net.ipv6.*`

### Kind configuration files

We are providing configuration files for [kind](https://kind.sigs.k8s.io/), which allow the necessary unsafe sysctls, in the directory [kind_configs/](./kind_configs/).

## Dependencies

### [Meshnet-CNI](https://github.com/networkop/meshnet-cni/tree/master)

It allows the creation of pod-to-pod direct connections across nodes using [VXLAN](https://en.wikipedia.org/wiki/Virtual_Extensible_LAN) and [veth](https://man7.org/linux/man-pages/man4/veth.4.html).

> [!WARNING]
> When it is used in an IPv6-only cluster, there is an **issue** with gRPC in the implementation of Meshnet-CNI.
We have **patched** the implementation of Meshnet and opened a [pull request](https://github.com/networkop/meshnet-cni/pull/83) on the [official repository](https://github.com/networkop/meshnet-cni). In the meantime, the [patched version](https://github.com/maxgoffart/meshnet-cni/tree/fix_grpc_ipv6) **must** be used if you are using an IPv6-only cluster.

Once you have cloned the patched Meshnet-CNI and launched your cluster, you need to use the following command, inside the Meshnet-CNI repository, to install Meshnet-CNI on your cluster:
```shell
make docker
make install
kubectl apply -k manifests/base
```

Finally, you can deploy the architecture on Kubernetes:
```shell
make k8s_start
```

You can check that Meshnet-CNI is running properly by using the following command and verifying that the column `READY` displays the correct number of nodes in your cluster:
```shell
kubectl get daemonset -n meshnet
```

## Security consideration

> [!CAUTION]
> Be aware that the pods generated by MSTG will run as "**privileged**" ([docs](https://kubernetes.io/docs/concepts/security/pod-security-standards/#privileged)) with `NET_ADMIN` and `SYS_ADMIN` capabilities.

## Limitations

The following limitations apply when deploying the topology to Kubernetes.

### Node port range

We generate a Kubernetes service of type [NodePort](https://kubernetes.io/docs/concepts/services-networking/service/#type-nodeport) for every entity in the topology.

By default, most Kubernetes distribution have [30,000;32,767] has a default port range for NodePort.
Thus, you are **limited to 2768 entities**.

However, it is possible to modify this range.
In its current state, MSTG assumes that you are using the aforementioned range.
If not, you need to modify the values `K8S_DEFAULT_NODE_PORT_MIN` and `K8S_DEFAULT_NODE_PORT_MAX` in the file [constants.py](./generator/constants.py).

### IPs of Meshnet' interfaces

As stated in [dependencies](#dependencies), we are using `Meshnet-CNI` for pod-to-pod direct communications, which creates new interfaces in every pod and connect these new interfaces to other pods. Thus, we need to assign IP addresses to these.

#### IPv4

When deploying using IPv4, we are using /30 subnets of 10.0.0.0/8.

This leaves you the possibility to create $2^22$ networks, where a network is equal to a connection between 2 entities.

#### IPv6

When deploying using IPv6, we are using /124 subnets of fd00::/8 (IPv6 unique local address).

This leaves you the possibility to create $2^116$ networks, where a network is equal to a connection between 2 entities.

### Service IP range

The Kubernetes control plane will automatically assign an IP address from a given range to every service.

This range depends on your Kubernetes distribution and is modifiable.

You can check this range using the following command:
```shell
kubectl cluster-info dump | grep -m 1 service-cluster-ip-range
```

### Pod IP range

Similarly, the control plane will assign an IP address from a given range to every pod in your cluster.

As for the range for the services, it depends on your Kubernetes distribution and is modifiable.

You can check this range using the following command:
```shell
kubectl cluster-info dump | grep -m 1 cluster-cidr
```

## Environment

Tested on:
- Linux 5.17;
- Ubuntu 22.04 LTS;
- Docker engine 25.0.3;
- Kind v0.20.0 (kind v0.20.0 go1.21.4 linux/amd64).
