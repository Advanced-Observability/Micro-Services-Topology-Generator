"""
Entities generated by MSTG.
"""

import ipaddress
from abc import ABC, abstractmethod

import network


class Entity(ABC):
    """Represent every entity in the architecture."""

    # used to assign a unique IOAM id to every entity
    ioam_counter = 0

    def __init__(self, name: str, kubernetes_ip):
        self.name = name
        self.ioam_id = Entity.ioam_counter + 1
        Entity.ioam_counter += 1
        self.kubernetes_ip = kubernetes_ip

        # networks to which the entity is attached
        self.attached_networks: list[network.Network] = []
        # list of names of entities on which the current one depends
        # used by docker compose to start the containers in the appropriate order
        self.depends_on: set[str] = set()
        # hosts to which the entity is connected to in end-to-end connections
        # used for dns configuration
        self.extra_hosts: set[tuple[str, ipaddress.IPv4Address | ipaddress.IPv6Address]] = set()
        # end-to-end connections
        self.e2e_conns: list[str] = []
        # list of commands to execute to configure the entity
        self.commands: list[str] = []

    def string(self, separator) -> str:
        """String representation of entity."""
        networks = ""
        for net in self.attached_networks:
            networks+=f"{net.name}, "

        return f"Entity: {self.name}"\
                f"{separator}- ioam_id: {self.ioam_id}"\
                f"{separator}- k8s IP: {self.kubernetes_ip}"\
                f"{separator}- networks: {networks}"\
                f"{separator}- e2e-connections: {self.e2e_conns}"\
                f"{separator}- depends-on: {self.depends_on}"\
                f"{separator}- extra-hosts: {self.extra_hosts}"\
                f"{separator}- commands: {self.commands_to_str()}"

    def __str__(self) -> str:
        return self.string(" ")

    def pretty(self) -> str:
        """Pretty print the entity."""
        return self.string("\n\t\t")

    def commands_to_str(self, pretty: bool = False) -> str:
        """Export all commands in a string."""
        string = ""
        for cmd in self.commands:
            if pretty:
                string += f"\n\t\t\t- {str(cmd)}"
            else:
                string += f",{str(cmd)}"

        return string

    def cmds_combined(self, k8s = False, separator = "&"):
        """Combine all commands in a single one."""
        combined = ""
        for cmd in self.commands:
            if not k8s:
                combined += f" ({cmd}) {separator}"
            else:
                # sleep to be sure that interfaces had time to be configured properly by meshnet cni
                combined += f" (sleep 20 && {cmd}) {separator}"
        return combined

    def get_network_pos(self, name: str) -> int | None:
        """
        Get id of attached network with given `name`.
        If not found, return None.
        """

        return next((i for i, net in enumerate(self.attached_networks) if net.name == name), None)

    def count_l3_networks(self) -> int:
        """Count number of L3 networks to which the entity is attached."""

        return sum(1 for net in self.attached_networks if net.type == network.NetworkType.L3_NET)

    @abstractmethod
    def export_compose(self, file) -> None:
        """Export the entity in the given Docker Compose `file`."""

    @abstractmethod
    def export_k8s(self) -> None:
        """Export the entity to Kubernetes configuration files."""
